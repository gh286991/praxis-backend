name: "python-safe-env"

# Logic:
# The container is already isolated by Docker.
# We use NsJail to enforce:
# 1. Time limit (2s)
# 2. Memory limit (64MB)
# 3. File system read-only (except tmp)
# 4. Strict PID limit

description: "Safe Python execution environment"

# Mode: ONCE - Execute command once and exit
mode: ONCE

# User to switch to inside the jail
# We map internal UID 999 to external nobody or similar
uidmap { inside_id: "999" outside_id: "65534" count: 1 }
gidmap { inside_id: "999" outside_id: "65534" count: 1 }

# Hostname inside jail
hostname: "runner"

# Current directory inside jail
cwd: "/app"

# Time limit (seconds)
time_limit: 2

# Mount strict file system
mount {
    src: "/"
    dst: "/"
    is_bind: true
    rw: false  # Read-only root
}

# Mount /tmp as RW for temp files if needed
mount {
    src: "/tmp"
    dst: "/tmp"
    is_bind: true
    rw: true
}

# Mount /dev/null, /dev/random, etc.
mount {
    src: "/dev/null"
    dst: "/dev/null"
    is_bind: true
    rw: true
}
mount {
    src: "/dev/urandom"
    dst: "/dev/urandom"
    is_bind: true
    rw: true
}

# Mount /app/temp for user scripts (shared with host/backend)
mount {
    src: "/app/temp"
    dst: "/app/temp"
    is_bind: true
    rw: false # Read-only for safety
}

# Resource limits
# Memory limit (in MB)
rlimit_as: 64

# CPU time limit (in seconds) - separate from wall time_limit
rlimit_cpu: 2

# File size limit (output) - 1MB
rlimit_fsize: 1

# Max number of processes
rlimit_nproc: 1

# Environment variables
envar: "PYTHONIOENCODING=utf-8"
envar: "LANG=C.UTF-8"
